<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sorteo de Territorios en Calendario Mensual</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Variables CSS para colores Material Design */
        :root {
            --md-primary: #1976D2; /* Azul oscuro */
            --md-primary-light: #2196F3; /* Azul estándar */
            --md-primary-dark: #1565C0; /* Azul más oscuro */
            --md-accent: #FF5722; /* Naranja acentuado */
            --md-text: #212121; /* Texto principal oscuro */
            --md-text-light: #757575; /* Texto secundario */
            --md-background: #F5F5F5; /* Fondo claro */
            --md-surface: #FFFFFF; /* Superficie de elementos */
            --md-shadow: rgba(0, 0, 0, 0.2); /* Sombra suave */

            /* New variables for group colors */
            --group-A-color: #26A69A; /* Teal */
            --group-B-color: #AB47BC; /* Purple */
            --group-C-color: #673AB7; /* Deep Purple for Group C */
            --group-D-color: #EF5350; /* Red */
            --group-E-color: #66BB6A; /* Green */
            --group-F-color: #42A5F5; /* Blue */
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--md-background);
            color: var(--md-text);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            background-color: var(--md-surface);
            padding: 30px;
            border-radius: 8px; /* Bordes ligeramente redondeados */
            box-shadow: 0 4px 10px var(--md-shadow); /* Sombra más pronunciada */
            max-width: 900px;
            width: 100%;
            text-align: center;
        }

        h1 {
            color: var(--md-primary-dark);
            margin-bottom: 15px;
            font-weight: 500;
        }

        p {
            margin-bottom: 25px;
            font-size: 1em; /* Ajustado ligeramente */
            color: var(--md-text-light);
        }

        .controls {
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        .controls label {
            font-weight: 500;
            color: var(--md-text);
        }

        .controls select {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
            flex-grow: 1;
            min-width: 120px;
            background-color: var(--md-surface);
            color: var(--md-text);
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
            appearance: none; /* Eliminar estilo nativo del select */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2020%2020%22%3E%3Cpath%20d%3D%22M5.293%207.293a1%201%200%20011.414%200L10%2010.586l3.293-3.293a1%201%200%20111.414%201.414l-4%204a1%201%200%2001-1.414%200l-4-4a1%201%200%20010-1.414z%22%20fill%3D%22%23757575%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 1em;
        }

        .controls button {
            background-color: var(--md-primary-light);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s ease, box-shadow 0.2s ease;
            flex-grow: 1;
            min-width: 150px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); /* Sombra para botón */
        }

        .controls button:hover {
            background-color: var(--md-primary-dark);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .controls button:active {
            background-color: var(--md-primary);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        #uncheckAllBtn {
            background-color: var(--md-accent); /* Color acentuado para desmarcar */
        }

        #uncheckAllBtn:hover {
            background-color: #E64A19;
            color: #fff;/* Tono más oscuro del acento */
        }
        #uncheckAllBtn:active {
            background-color: #D84315;
        }

        /* Styling for "Limpiar Asignaciones" button */
        #clearAssignmentsBtn {
            background-color: #2196F3; /* Blue Grey */
            margin-top: 20px;
             padding: 5px;
        }

        #clearAssignmentsBtn:hover {
            background-color: #1976D2; /* Darker Blue Grey */
        }

        #clearAssignmentsBtn:active {
            background-color: #1976D2;/* Even Darker Blue Grey */
        }

        .number-selection, .group-selection, .day-group-assignment {
            background-color: var(--md-surface);
            border: 1px solid #e0e0e0; /* Borde más suave */
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: left;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Sombra para la sección */
        }

        .number-selection h3, .group-selection h3, .day-group-assignment h3 {
            margin-top: 0;
            color: var(--md-primary-dark);
            text-align: center;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .number-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
            justify-content: center;
        }

        /* Estilo para los números (antes labels con checkbox) */
        .number-item {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 50px; /* Tamaño fijo para el círculo/cuadrado */
            height: 50px;
            border-radius: 50%; /* Forma de círculo por defecto */
            background-color: #ECEFF1; /* Gris claro, sin seleccionar */
            color: var(--md-text-light);
            font-weight: 500;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;
            box-shadow: 0 2px 3px rgba(0,0,0,0.1);
            user-select: none; /* Evitar selección de texto */
        }

        /* Estilo para número seleccionado */
        .number-item.selected {
            background-color: var(--md-primary-light);
            color: white;
            box-shadow: 0 3px 6px rgba(0,0,0,0.25);
            transform: translateY(-2px); /* Ligero efecto de "levantar" */
        }

        .number-item:hover {
            background-color: #CFD8DC; /* Gris un poco más oscuro en hover */
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }
        .number-item.selected:hover {
             background-color: var(--md-primary-dark);
             box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        /* Estilo para número deshabilitado (not used in current logic) */
        .number-item.disabled {
            background-color: #E0E0E0;
            color: #BDBDBD;
            cursor: not-allowed;
            opacity: 0.7;
            box-shadow: none;
            transform: none;
        }

        .group-selection-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .group-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: 500;
            color: var(--md-text);
            padding: 8px 12px;
            border: 1px solid #CFD8DC;
            border-radius: 4px;
            background-color: #ECEFF1;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
        }
        .group-checkbox:hover {
            background-color: #DEE4E7;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .group-checkbox input[type="checkbox"] {
            /* Basic styling for checkbox, can be custom-styled for Material Design look */
            width: 18px;
            height: 18px;
            accent-color: var(--md-primary-light); /* Apply accent color to checkbox */
            cursor: pointer;
        }
        .group-checkbox.checked {
            background-color: var(--md-primary-light);
            color: white;
            border-color: var(--md-primary-dark);
            box-shadow: 0 3px 6px rgba(0,0,0,0.25);
        }
        .group-checkbox.checked input[type="checkbox"] {
             accent-color: white; /* For checked state, try to make inner check white if possible */
        }


        .day-group-assignment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .day-assignment-item {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
        }

        .day-assignment-item label {
            font-weight: 500;
            color: var(--md-text);
        }

        .day-assignment-item select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 0.95em;
        }


        .calendar-container {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            background-color: var(--md-surface);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .calendar-header {
            font-size: 1.4em;
            font-weight: 500;
            margin-bottom: 15px;
            color: var(--md-primary-dark);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }

        .day-name, .day-cell {
            padding: 10px 5px;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            word-wrap: break-word;
        }

        .day-name {
            background-color: #E0E0E0; /* Gris más Material */
            font-weight: 500;
            color: var(--md-text);
            font-size: 0.9em;
        }

        .day-cell {
            background-color: #FAFAFA; /* Gris muy claro */
            border: 1px solid #E0E0E0; /* Borde más suave */
            min-height: 70px;
            position: relative;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); /* Sombra interior */
        }

        .day-cell.current-month {
            background-color: var(--md-surface);
        }

        .day-number {
            font-weight: 500;
            font-size: 1em;
            color: var(--md-primary);
            margin-bottom: 5px;
        }

        .random-number {
            font-size: 1.2em;
            font-weight: 700; /* Más bold para destacar */
            border-radius: 4px;
            padding: 2px 6px; /* Más padding */
            margin-top: 5px;
            display: inline-block;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: all 0.2s ease-in-out; /* Smooth transition for color changes */

            /* Default, if not part of a specific group assignment */
            color: #388E3C; /* Green */
            background-color: #E8F5E9; /* Light Green */
        }

        /* Styles for group-assigned numbers */
        .random-number.group-A {
            background-color: #E0F2F1; /* Light Teal */
            color: var(--group-A-color);
        }
        .random-number.group-B {
            background-color: #F3E5F5; /* Light Purple */
            color: var(--group-B-color);
        }
        .random-number.group-C {
            background-color: #EDE7F6; /* Light Deep Purple */
            color: var(--group-C-color);
        }
        .random-number.group-D {
            background-color: #FFEBEE; /* Light Red */
            color: var(--group-D-color);
        }
        .random-number.group-E {
            background-color: #E8F5E9; /* Light Green */
            color: var(--group-E-color);
        }
        .random-number.group-F {
            background-color: #E3F2FD; /* Light Blue */
            color: var(--group-F-color);
        }

        /* Override for repeated numbers (general, if they were to happen) */
        .random-number.repeated {
            background-color: #FFF3E0; /* Light orange */
            color: #EF6C00; /* Darker orange */
            border: 1px solid #FFCC80;
        }

        /* Specifically for repeated numbers within Group F */
        .random-number.group-F.repeated {
            background-color: #FFECB3; /* Lighter Orange for repeated F */
            color: #FF8F00; /* Darker Orange for repeated F */
            border: 1px solid #FFD54F;
        }

        .empty-cell {
            background-color: #EEEEEE; /* Gris más sólido */
            color: #BDBDBD; /* Texto gris claro */
        }

        .monday {
            background-color: #FFEBEE; /* Rojo muy claro */
            color: #D32F2F; /* Rojo más oscuro */
            border-color: #FFCDD2; /* Borde más suave */
        }

        /* --- Media Queries para hacer el diseño responsive --- */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.6em;
            }

            p {
                font-size: 0.95em;
            }

            .controls {
                flex-direction: column;
                gap: 10px;
            }

            .controls select,
            .controls button {
                width: 100%;
                max-width: 300px;
            }

            .number-selection, .group-selection, .day-group-assignment {
                padding: 15px;
            }

            .number-grid {
                grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); /* Más pequeños */
                gap: 8px;
            }

            .number-item {
                width: 40px; /* Reducir tamaño de los círculos */
                height: 40px;
                font-size: 1em;
            }
            .number-item.selected {
                transform: none; /* Eliminar efecto de "levantar" en móviles */
            }

            .group-selection-grid {
                flex-direction: column;
            }

            .day-group-assignment-grid {
                grid-template-columns: 1fr;
            }

            .calendar-container {
                max-width: 100%;
                min-width: unset;
                padding: 10px;
            }

            .calendar-header {
                font-size: 1.2em;
                margin-bottom: 10px;
            }

            .day-name, .day-cell {
                padding: 8px 3px;
                min-height: 55px; /* Ajusta la altura de las celdas */
            }

            .day-number {
                font-size: 0.85em;
            }

            .random-number {
                font-size: 0.95em;
                padding: 1px 3px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 10px;
            }

            h1 {
                font-size: 1.4em;
            }

            p {
                font-size: 0.85em;
            }

            .day-name {
                font-size: 0.75em;
            }

            .day-number {
                font-size: 0.75em;
            }

            .random-number {
                font-size: 0.85em;
            }

            .number-grid {
                grid-template-columns: repeat(auto-fill, minmax(35px, 1fr)); /* Aún más pequeños */
                gap: 5px;
            }
            .number-item {
                width: 35px; /* Reducir tamaño de los círculos */
                height: 35px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Territorios por Mes</h1>
        
        <div class="controls">
            <label for="startMonth">Mes</label>
            <select id="startMonth"></select>
            <label for="startYear">Año:</label>
            <select id="startYear"></select>
            <button id="generateBtn">Iniciar</button>
            <button id="uncheckAllBtn">Deseleccionar Todos</button>
        </div>

        <div class="group-selection">
            <h3>Seleccionar Grupos de Territorios</h3>
            <div class="group-selection-grid">
                <label class="group-checkbox">
                    <input type="checkbox" id="groupA" data-group="A"> Grupo A (1-6)
                </label>
                <label class="group-checkbox">
                    <input type="checkbox" id="groupB" data-group="B"> Grupo B (7-12)
                </label>
                <label class="group-checkbox">
                    <input type="checkbox" id="groupC" data-group="C"> Grupo C (15,18,22-25)
                </label>
                <label class="group-checkbox">
                    <input type="checkbox" id="groupD" data-group="D"> Grupo D (19-21,28,29,33)
                </label>
                <label class="group-checkbox">
                    <input type="checkbox" id="groupE" data-group="E"> Grupo E (26,27,30-32,34,35)
                </label>
                <label class="group-checkbox">
                    <input type="checkbox" id="groupF" data-group="F"> Grupo F (13,14,16,17)
                </label>
            </div>
        </div>

        <div class="number-selection">
            <h3>Territorios (<span id="selectedCount">0</span>/35)</h3>
            <div class="number-grid" id="numberGrid">
            </div>
        </div>

        <div class="day-group-assignment">
            <h3>Asignar Grupos a Días de la Semana</h3>
            <div class="day-group-assignment-grid"></div>
            <button id="clearAssignmentsBtn">Limpiar Asignaciones</button>
        </div>
        <div id="calendarContainer" class="calendar-container">
            <div class="calendar-header" id="calendarHeader"></div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const startMonthSelect = document.getElementById('startMonth');
            const startYearSelect = document.getElementById('startYear');
            const generateBtn = document.getElementById('generateBtn');
            const uncheckAllBtn = document.getElementById('uncheckAllBtn');
            const numberGrid = document.getElementById('numberGrid');
            const selectedCountSpan = document.getElementById('selectedCount');
            const clearAssignmentsBtn = document.getElementById('clearAssignmentsBtn');

            const calendarGrid = document.getElementById('calendarGrid');
            const calendarHeader = document.getElementById('calendarHeader');
            const dayGroupAssignmentGrid = document.querySelector('.day-group-assignment-grid');

            const dayNames = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
            const monthNames = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];

            // Define groups and their numbers
            const groups = {
                A: [1, 2, 3, 4, 5, 6],
                B: [7, 8, 9, 10, 11, 12],
                C: [15, 18, 22, 23, 24, 25],
                D: [19, 20, 21, 28, 29, 33],
                E: [26, 27, 30, 31, 32, 34, 35],
                F: [13, 14, 16, 17]
            };
            const allNumbers = Array.from({ length: 35 }, (_, i) => i + 1); // Numbers 1 to 35

            let selectedNumbersState = new Set(); // Use a Set for quick access
            let dayGroupAssignments = {}; // Stores assignments: { 'Martes': 'A', 'Jueves': 'C' }

            // --- Initial Population Functions ---

            function populateMonthAndYearSelects() {
                const currentYear = new Date().getFullYear();
                
                monthNames.forEach((name, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = name;
                    startMonthSelect.appendChild(option);
                });
                startMonthSelect.value = new Date().getMonth();

                for (let i = currentYear - 5; i <= currentYear + 5; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    startYearSelect.appendChild(option);
                }
                startYearSelect.value = currentYear;
            }

            function populateNumberSelection() {
                numberGrid.innerHTML = '';
                for (let i = 1; i <= 35; i++) {
                    const numberItem = document.createElement('div');
                    numberItem.classList.add('number-item');
                    numberItem.textContent = i;
                    numberItem.dataset.value = i;
                    
                    numberItem.addEventListener('click', toggleNumberSelection);
                    numberGrid.appendChild(numberItem);
                }
                updateSelectedCount();
                applyNumberItemState();
            }

            function populateDayGroupAssignments() {
                dayGroupAssignmentGrid.innerHTML = '';
                // Day mapping: 0: Sunday, 1: Monday, ..., 6: Saturday
                // We want to assign groups to Tuesday (2) through Sunday (0)
                const assignableDays = [
                    { name: 'Martes', index: 2 },
                    { name: 'Miércoles', index: 3 },
                    { name: 'Jueves', index: 4 },
                    { name: 'Viernes', index: 5 },
                    { name: 'Sábado', index: 6 },
                    { name: 'Domingo', index: 0 }
                ];

                assignableDays.forEach(day => {
                    const item = document.createElement('div');
                    item.classList.add('day-assignment-item');

                    const label = document.createElement('label');
                    label.textContent = `${day.name}:`;
                    label.htmlFor = `assign-${day.name}`;
                    item.appendChild(label);

                    const select = document.createElement('select');
                    select.id = `assign-${day.name}`;
                    select.dataset.dayName = day.name;
                    select.dataset.dayIndex = day.index; // Store numerical index for easier use
                    
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'Ninguno';
                    select.appendChild(defaultOption);

                    for (const groupName in groups) {
                        const option = document.createElement('option');
                        option.value = groupName;
                        option.textContent = `Grupo ${groupName}`;
                        select.appendChild(option);
                    }
                    select.addEventListener('change', (event) => {
                        const dayKey = event.target.dataset.dayName;
                        const groupValue = event.target.value;
                        
                        // Prevent assigning the same group to multiple days
                        for (const existingDay in dayGroupAssignments) {
                            if (dayGroupAssignments[existingDay] === groupValue && existingDay !== dayKey && groupValue !== '') {
                                // Silently reset if duplicate
                                event.target.value = ''; 
                                delete dayGroupAssignments[dayKey];
                                return;
                            }
                        }

                        if (groupValue) {
                            dayGroupAssignments[dayKey] = groupValue;
                        } else {
                            delete dayGroupAssignments[dayKey];
                        }
                    });
                    item.appendChild(select);
                    dayGroupAssignmentGrid.appendChild(item);
                });
            }

            // --- Number Selection Logic ---

            function toggleNumberSelection(event) {
                const numberItem = event.target;
                const numberValue = parseInt(numberItem.dataset.value);

                if (selectedNumbersState.has(numberValue)) {
                    selectedNumbersState.delete(numberValue);
                } else {
                    selectedNumbersState.add(numberValue);
                }
                updateSelectedCount();
                applyNumberItemState();
                updateGroupCheckboxes(); // Update group checkboxes based on individual selections
            }

            function updateSelectedCount() {
                selectedCountSpan.textContent = selectedNumbersState.size;
            }

            function applyNumberItemState() {
                numberGrid.querySelectorAll('.number-item').forEach(item => {
                    const numberValue = parseInt(item.dataset.value);
                    if (selectedNumbersState.has(numberValue)) {
                        item.classList.add('selected');
                    } else {
                        item.classList.remove('selected');
                    }
                    item.classList.remove('disabled'); // Removed disabled state
                });
            }

            function uncheckAllNumbers() {
                selectedNumbersState.clear();
                updateSelectedCount();
                applyNumberItemState();
                updateGroupCheckboxes(); // Uncheck all group checkboxes
                clearDayGroupAssignments(); // Also clear day assignments
            }

            // --- Group Selection Logic ---

            const groupCheckboxes = document.querySelectorAll('.group-checkbox input[type="checkbox"]');

            groupCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', (event) => {
                    const groupName = event.target.dataset.group;
                    const groupNumbers = groups[groupName];
                    const parentLabel = event.target.closest('label');

                    if (event.target.checked) {
                        groupNumbers.forEach(num => selectedNumbersState.add(num));
                        parentLabel.classList.add('checked');
                    } else {
                        groupNumbers.forEach(num => selectedNumbersState.delete(num));
                        parentLabel.classList.remove('checked');
                    }
                    updateSelectedCount();
                    applyNumberItemState();
                });
            });

            function updateGroupCheckboxes() {
                groupCheckboxes.forEach(checkbox => {
                    const groupName = checkbox.dataset.group;
                    const groupNumbers = groups[groupName];
                    const parentLabel = checkbox.closest('label');

                    // Check if all numbers in the group are selected
                    const allInGroupSelected = groupNumbers.every(num => selectedNumbersState.has(num));

                    checkbox.checked = allInGroupSelected;
                    if (allInGroupSelected) {
                        parentLabel.classList.add('checked');
                    } else {
                        parentLabel.classList.remove('checked');
                    }
                });
            }

            // --- Day Group Assignment Logic ---

            clearAssignmentsBtn.addEventListener('click', clearDayGroupAssignments);

            function clearDayGroupAssignments() {
                dayGroupAssignments = {};
                document.querySelectorAll('.day-group-assignment-grid select').forEach(select => {
                    select.value = ''; // Reset select value
                });
            }

            // --- Calendar Rendering Logic ---

            function getDateKey(date) {
                return date.toISOString().slice(0, 10);
            }

            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            function renderCalendar() {
                const selectedMonth = parseInt(startMonthSelect.value);
                const selectedYear = parseInt(startYearSelect.value);

                const firstDayOfMonth = new Date(selectedYear, selectedMonth, 1);
                firstDayOfMonth.setHours(0, 0, 0, 0);
                const lastDayOfMonth = new Date(selectedYear, selectedMonth + 1, 0);
                lastDayOfMonth.setHours(0, 0, 0, 0);

                const finalAssignments = new Map(); // Stores dateKey -> { number: num, repeated: boolean, group: 'A'|'B'|... }
                const usedUniqueNumbers = new Set(); // To ensure unique numbers are used first globally

                // Get all assignable dates in the month (excluding Mondays)
                const assignableDates = [];
                let tempDate = new Date(firstDayOfMonth);
                while (tempDate <= lastDayOfMonth) {
                    if (tempDate.getDay() !== 1) { // Skip Monday (1)
                        assignableDates.push(getDateKey(tempDate));
                    }
                    tempDate.setDate(tempDate.getDate() + 1);
                }

                // --- Automatic Number Selection (if needed) ---
                // Identify which groups are assigned to days
                const assignedGroupsInCalendar = new Set(Object.values(dayGroupAssignments));
                
                // Keep track of how many unique numbers are needed from each assigned group for exclusive days
                const groupNeeds = {};
                for (const groupName of assignedGroupsInCalendar) {
                    groupNeeds[groupName] = 0;
                }

                tempDate = new Date(firstDayOfMonth);
                while (tempDate <= lastDayOfMonth) {
                    const dayOfWeek = tempDate.getDay();
                    if (dayOfWeek !== 1) { // Not Monday
                        const currentDayName = dayNames[dayOfWeek === 0 ? 6 : dayOfWeek - 1];
                        if (dayGroupAssignments[currentDayName]) {
                            groupNeeds[dayGroupAssignments[currentDayName]]++;
                        }
                    }
                    tempDate.setDate(tempDate.getDate() + 1);
                }

                // For each assigned group, ensure enough numbers are selected
                let numbersAddedAutomatically = false;
                for (const groupName of assignedGroupsInCalendar) {
                    const groupMembers = groups[groupName];
                    const selectedInGroup = groupMembers.filter(num => selectedNumbersState.has(num)).length;
                    
                    if (selectedInGroup < groupNeeds[groupName]) {
                        const needed = groupNeeds[groupName] - selectedInGroup;
                        const availableToAdd = groupMembers.filter(num => !selectedNumbersState.has(num));
                        
                        // Add up to 'needed' numbers from this group to selectedNumbersState
                        for (let i = 0; i < Math.min(needed, availableToAdd.length); i++) {
                            selectedNumbersState.add(availableToAdd[i]);
                            numbersAddedAutomatically = true;
                        }
                    }
                }
                if (numbersAddedAutomatically) {
                    // Update UI if numbers were added automatically
                    updateSelectedCount();
                    applyNumberItemState();
                    updateGroupCheckboxes();
                }
                // Re-prepare pools based on potentially updated selectedNumbersState
                let availableUniqueNumbersPool = shuffleArray(Array.from(selectedNumbersState));
                const groupSpecificAvailableNumbers = {};
                for (const groupName in groups) {
                    groupSpecificAvailableNumbers[groupName] = shuffleArray(
                        groups[groupName].filter(num => selectedNumbersState.has(num))
                    );
                }

                // --- Pass 1: Assign numbers from explicitly assigned groups ---
                currentDate = new Date(firstDayOfMonth);
                while (currentDate <= lastDayOfMonth) {
                    const dayOfWeek = currentDate.getDay(); // 0: Sunday, 1: Monday, ..., 6: Saturday
                    const dateKey = getDateKey(currentDate);

                    if (dayOfWeek === 1) { // Skip Mondays
                        currentDate.setDate(currentDate.getDate() + 1);
                        continue;
                    }

                    const currentDayName = dayNames[dayOfWeek === 0 ? 6 : dayOfWeek - 1]; 

                    if (dayGroupAssignments[currentDayName]) {
                        const assignedGroup = dayGroupAssignments[currentDayName];
                        const groupNumsPool = groupSpecificAvailableNumbers[assignedGroup];
                        
                        let numberToPlace = null;
                        let isRepeated = false;

                        // Try to get a unique number for this group that hasn't been used globally yet
                        const uniqueInGroupNotGloballyUsed = groupNumsPool.filter(num => !usedUniqueNumbers.has(num));
                        
                        if (uniqueInGroupNotGloballyUsed.length > 0) {
                            numberToPlace = uniqueInGroupNotGloballyUsed.shift();
                            usedUniqueNumbers.add(numberToPlace);
                        } else if (assignedGroup === 'F' && groupNumsPool.length > 0) {
                            // Special rule for Group F: if no unique numbers left, repeat from its own pool
                            // Ensure it's not a number that was already uniquely assigned *in this pass*
                            const availableForFRepetition = groupNumsPool.filter(num => !finalAssignments.has(dateKey) || (finalAssignments.get(dateKey).group !== 'F' && finalAssignments.get(dateKey).number !== num));
                            if (availableForFRepetition.length > 0) {
                                numberToPlace = availableForFRepetition[Math.floor(Math.random() * availableForFRepetition.length)];
                                isRepeated = true;
                            }
                        }

                        if (numberToPlace !== null) {
                            finalAssignments.set(dateKey, { 
                                number: numberToPlace, 
                                repeated: isRepeated, 
                                group: assignedGroup 
                            });
                        }
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                // --- Pass 2: Assign remaining general unique selected numbers to unassigned days ---
                availableUniqueNumbersPool = availableUniqueNumbersPool.filter(num => !usedUniqueNumbers.has(num));
                
                tempDate = new Date(firstDayOfMonth); // Reset date for second pass
                while (tempDate <= lastDayOfMonth && availableUniqueNumbersPool.length > 0) {
                    const dayOfWeek = tempDate.getDay();
                    const dateKey = getDateKey(tempDate);

                    if (dayOfWeek === 1) { // Skip Mondays
                        tempDate.setDate(tempDate.getDate() + 1);
                        continue;
                    }

                    // If this day doesn't already have a number assigned (from a group in Pass 1)
                    if (!finalAssignments.has(dateKey)) {
                        const numberToPlace = availableUniqueNumbersPool.shift(); // Take next unique number
                        finalAssignments.set(dateKey, { number: numberToPlace, repeated: false, group: null });
                        usedUniqueNumbers.add(numberToPlace); 
                    }
                    tempDate.setDate(tempDate.getDate() + 1);
                }
                
                // No need for a third pass to fill with general repeated numbers,
                // as the requirement is now to auto-select enough unique numbers from groups.
                // If a day still remains empty after Pass 1 and Pass 2 (which should only happen if
                // there aren't enough total numbers across all groups to fill all non-Monday days),
                // it will simply be left empty as per original "no importa si no aparece" for unassigned numbers.

                renderSingleCalendar(calendarGrid, calendarHeader, selectedYear, selectedMonth, finalAssignments);
            }

            function renderSingleCalendar(gridElement, headerElement, year, month, assignmentsMap) {
                gridElement.innerHTML = '';
                headerElement.textContent = `${monthNames[month]} ${year}`;

                // Day names (adjusted for Lunes = 0)
                const displayDayNames = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
                displayDayNames.forEach(name => {
                    const dayNameCell = document.createElement('div');
                    dayNameCell.classList.add('day-name');
                    dayNameCell.textContent = name;
                    gridElement.appendChild(dayNameCell);
                });

                const firstDayOfMonth = new Date(year, month, 1);
                firstDayOfMonth.setHours(0, 0, 0, 0);
                const lastDayOfMonth = new Date(year, month + 1, 0);
                lastDayOfMonth.setHours(0, 0, 0, 0);

                let firstDayIndex = firstDayOfMonth.getDay(); // 0: Sunday, 1: Monday, ..., 6: Saturday
                if (firstDayIndex === 0) { // If it's Sunday, it should be the 6th position (after Sat)
                    firstDayIndex = 6;
                } else { // For Monday (1) to Saturday (6), subtract 1 to make Monday index 0
                    firstDayIndex = firstDayIndex - 1;
                }

                for (let i = 0; i < firstDayIndex; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.classList.add('day-cell', 'empty-cell');
                    gridElement.appendChild(emptyCell);
                }

                for (let day = 1; day <= lastDayOfMonth.getDate(); day++) {
                    const currentDay = new Date(year, month, day);
                    currentDay.setHours(0, 0, 0, 0);
                    const dayOfWeek = currentDay.getDay(); // 0: Sunday, 1: Monday, ..., 6: Saturday

                    const dayCell = document.createElement('div');
                    dayCell.classList.add('day-cell', 'current-month');

                    const dayNumberSpan = document.createElement('span');
                    dayNumberSpan.classList.add('day-number');
                    dayNumberSpan.textContent = day;
                    dayCell.appendChild(dayNumberSpan);

                    if (dayOfWeek === 1) { // 1 is Monday
                        dayCell.classList.add('monday');
                    }

                    const dateKey = getDateKey(currentDay);
                    const assignment = assignmentsMap.get(dateKey); // Get the {number, repeated, group} object

                    if (assignment) {
                        const randomNumberSpan = document.createElement('span');
                        randomNumberSpan.classList.add('random-number');
                        randomNumberSpan.textContent = assignment.number;
                        
                        if (assignment.group) {
                            randomNumberSpan.classList.add(`group-${assignment.group}`);
                        }
                        if (assignment.repeated) {
                            randomNumberSpan.classList.add('repeated');
                        }
                        dayCell.appendChild(randomNumberSpan);
                    }
                    
                    gridElement.appendChild(dayCell);
                }

                const totalRenderedCells = gridElement.children.length - 7;
                const remainingCells = (7 - (totalRenderedCells % 7)) % 7;
                for (let i = 0; i < remainingCells; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.classList.add('day-cell', 'empty-cell');
                    gridElement.appendChild(emptyCell);
                }
            }

            // --- Initialization ---
            populateMonthAndYearSelects();
            populateNumberSelection(); // Generates the number DIVs
            populateDayGroupAssignments(); // Generates day assignment selects
            updateGroupCheckboxes(); // Ensure initial state reflects all numbers selected
            renderCalendar(); // Initial render

            // --- Event Listeners ---
            generateBtn.addEventListener('click', renderCalendar);
            uncheckAllBtn.addEventListener('click', uncheckAllNumbers);
        });
    </script>
</body>
</html>
```
